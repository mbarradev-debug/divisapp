# Version 1.6.0

**Release Date**: January 2026

## Summary

Version 1.6.0 introduces Web Push notifications to DivisApp. Users can now opt-in to receive push notifications directly in their browser, enabling real-time alerts for economic indicator updates.

## Features in This Version

### Core Features (from previous versions)
- Home page with all Chilean economic indicators
- Favorites system with drag-and-drop reordering
- Indicator detail pages with historical charts
- 7/30/90 day range selection for analytics
- Currency conversion with smart defaults
- Settings page with user preferences
- Local persistence via localStorage

### New in v1.6.0

#### Web Push Notifications
- **Permission Flow**: Users can grant or deny notification permissions through a clean UI in the Settings page
- **Subscription Management**: Browser push subscriptions are stored in Supabase for cross-device delivery
- **Push Delivery**: Notifications are sent via a Supabase Edge Function using the Web Push protocol
- **Service Worker**: A dedicated service worker handles incoming push events and displays system notifications
- **Testing Tools**: Development tools for testing push delivery in the Settings page

#### Technical Infrastructure
- **VAPID Authentication**: Secure push delivery using VAPID (Voluntary Application Server Identification)
- **Payload Encryption**: All push payloads are encrypted using the aes128gcm content encoding
- **CORS Support**: Edge Function properly handles cross-origin requests for local development
- **Browser Compatibility**: Fallbacks for older browsers that lack `crypto.randomUUID()`

## Architecture Changes

### New Files
- `public/sw.js` - Service Worker for handling push events
- `lib/push/` - Push notification domain models and utilities
- `lib/supabase/push-subscriptions.ts` - Supabase client for subscription management
- `supabase/functions/send-push/` - Edge Function for push delivery
- `supabase/migrations/20260115_create_push_subscriptions.sql` - Database schema

### Database Schema
```sql
create table push_subscriptions (
  endpoint text primary key,
  p256dh text not null,
  auth text not null,
  user_id uuid references auth.users(id),
  expiration_time bigint,
  user_agent text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);
```

## What Is Not Included

- **Scheduled Notifications**: No automated notifications based on indicator changes
- **Notification Preferences**: No per-indicator notification settings
- **Rich Notifications**: No images or action buttons in notifications
- **iOS Safari Support**: Web Push on iOS requires additional PWA setup

## Stability Notes

- Web Push is functional for Chrome, Firefox, and Edge on desktop and Android
- The Edge Function requires VAPID keys to be configured in Supabase secrets
- Local development requires the frontend to run on `http://localhost:3000` for CORS

## Environment Configuration

Required environment variables:
```
NEXT_PUBLIC_VAPID_PUBLIC_KEY=<base64url-encoded-public-key>
```

Required Supabase secrets:
```
VAPID_PUBLIC_KEY=<base64url-encoded-public-key>
VAPID_PRIVATE_KEY=<base64url-encoded-private-key>
```

## Changelog from v1.5.0

### Added
- Web Push permission and subscription flow
- Push notification domain models
- Service Worker for push event handling
- Supabase Edge Function for push delivery
- VAPID authentication for push services
- Push testing tools in Settings page
- CORS headers for local development
- Browser compatibility fallback for `crypto.randomUUID()`

### Changed
- Settings page now includes notification permission controls
- Supabase client extended with push subscription methods

### Fixed
- VAPID key import now uses JWK format instead of PKCS#8
- All Edge Function responses include CORS headers

## Migration Guide

To upgrade from v1.5.0:

1. Run the database migration:
   ```bash
   npx supabase db push
   ```

2. Configure VAPID secrets:
   ```bash
   npx supabase secrets set \
     VAPID_PUBLIC_KEY="<your-public-key>" \
     VAPID_PRIVATE_KEY="<your-private-key>"
   ```

3. Deploy the Edge Function:
   ```bash
   npx supabase functions deploy send-push
   ```

4. Add `NEXT_PUBLIC_VAPID_PUBLIC_KEY` to your `.env.local`

5. Rebuild and deploy the frontend
